<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoGuessr Clone</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin="anonymous" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    .game-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .game-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .map-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }
    .street-view {
      width: 100%;
      height: 500px;
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    .compass {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .compass::before {
      content: "N";
      position: absolute;
      top: 5px;
      color: #ff0000;
    }
    .compass::after {
      content: "S";
      position: absolute;
      bottom: 5px;
      color: #000;
    }
    .compass-arrow {
      width: 2px;
      height: 20px;
      background: #000;
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: bottom center;
      transform: translate(-50%, -100%);
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .game-footer {
      text-align: center;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 500px;
      font-size: 18px;
      color: #666;
      background-color: #fff;
      border-radius: 8px;
    }
    .loading-note {
      font-size: 14px;
      color: #999;
      margin-top: 10px;
    }
    .results {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .score {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    .distance {
      font-size: 18px;
      color: #666;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game-header">
      <h1>GeoGuessr Clone</h1>
      <div id="round-info">Round 1 of 5</div>
    </div>

    <div class="map-container">
      <div id="street-view" class="street-view">
        <div class="compass">
          <div class="compass-arrow"></div>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div class="game-footer">
      <button id="guess-btn" onclick="makeGuess()">Make Guess</button>
      <button id="next-btn" onclick="nextRound()" style="display: none;">Next Round</button>
    </div>

    <div id="results" class="results">
      <h2>Results</h2>
      <div class="score">Score: <span id="score">0</span></div>
      <div class="distance">Distance: <span id="distance">0</span> km</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin="anonymous"></script>

  <script>
    let map = null;
    let marker = null;
    let panorama = null;
    let currentLocation = null;
    let currentRound = 1;
    const maxRounds = 5;
    let totalScore = 0;
    let usedLocations = [];

    // Function to generate random coordinates
    function getRandomCoordinates() {
      // Generate random latitude between -55 and 70 (excluding extreme north/south)
      const lat = Math.random() * 125 - 55;
      // Generate random longitude between -180 and 180
      const lng = Math.random() * 360 - 180;
      return { lat, lng };
    }

    // Function to check if a location has Street View coverage
    function checkStreetViewCoverage(lat, lng) {
      return new Promise((resolve) => {
        const sv = new google.maps.StreetViewService();
        sv.getPanorama({ location: { lat, lng }, radius: 50000 }, (data, status) => {
          if (status === 'OK') {
            resolve({
              hasCoverage: true,
              location: {
                lat: data.location.latLng.lat(),
                lng: data.location.latLng.lng()
              }
            });
          } else {
            resolve({ hasCoverage: false });
          }
        });
      });
    }

    // Function to find a random location with Street View coverage
    async function findRandomLocation() {
      let attempts = 0;
      const maxAttempts = 50; // Limit attempts to prevent infinite loop

      while (attempts < maxAttempts) {
        const coords = getRandomCoordinates();
        
        // Check if this location has been used before
        const isUsed = usedLocations.some(loc => 
          Math.abs(loc.lat - coords.lat) < 0.1 && 
          Math.abs(loc.lng - coords.lng) < 0.1
        );

        if (!isUsed) {
          const result = await checkStreetViewCoverage(coords.lat, coords.lng);
          
          if (result.hasCoverage) {
            usedLocations.push(result.location);
            return result.location;
          }
        }
        
        attempts++;
      }

      // If we couldn't find a new location, reset the used locations list
      usedLocations = [];
      return findRandomLocation();
    }

    // Initialize the game
    function initGame() {
      // Initialize map
      map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19,
        minZoom: 2
      }).addTo(map);

      // Load Google Maps API
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBJQmU6Bt9rHC2G5oHQFVjPbZcXomI9duU&libraries=places`;
      script.async = true;
      script.defer = true;
      script.onload = startNewRound;
      document.head.appendChild(script);
    }

    // Start a new round
    async function startNewRound() {
      try {
        // Get a random location with Street View coverage
        currentLocation = await findRandomLocation();

        // Initialize Street View
        panorama = new google.maps.StreetViewPanorama(
          document.getElementById('street-view'),
          {
            position: { lat: currentLocation.lat, lng: currentLocation.lng },
            pov: { heading: 165, pitch: 0 },
            zoom: 1,
            addressControl: false,
            showRoadLabels: false,
            zoomControl: false,
            panControl: false,
            fullscreenControl: false,
            motionTracking: false,
            motionTrackingControl: false
          }
        );

        // Add compass rotation handler
        panorama.addListener('pov_changed', function() {
          const compass = document.querySelector('.compass');
          const heading = panorama.getPov().heading;
          compass.style.transform = `rotate(${heading}deg)`;
        });

        // Reset map and marker
        map.setView([0, 0], 2);
        if (marker) {
          map.removeLayer(marker);
        }
        marker = null;

        // Reset UI
        document.getElementById('guess-btn').style.display = 'inline-block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('round-info').textContent = `Round ${currentRound} of ${maxRounds}`;

        // Add click handler to map
        map.on('click', function(e) {
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker(e.latlng).addTo(map);
        });
      } catch (error) {
        console.error('Error starting new round:', error);
        alert('Error loading new location. Please try again.');
      }
    }

    // Make a guess
    function makeGuess() {
      if (!marker) {
        alert('Please click on the map to place your guess!');
        return;
      }

      const guessLat = marker.getLatLng().lat;
      const guessLng = marker.getLatLng().lng;
      const distance = calculateDistance(
        guessLat, guessLng,
        currentLocation.lat, currentLocation.lng
      );

      const score = Math.max(0, Math.round(5000 * Math.exp(-distance / 2000)));
      totalScore += score;

      // Show actual location
      const actualMarker = L.marker([currentLocation.lat, currentLocation.lng], {
        icon: L.divIcon({
          className: 'actual-location-marker',
          html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%;"></div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map);

      // Draw line between guess and actual location
      const line = L.polyline([
        [guessLat, guessLng],
        [currentLocation.lat, currentLocation.lng]
      ], {
        color: 'red',
        weight: 2,
        opacity: 0.7
      }).addTo(map);

      // Fit map to show both markers
      const bounds = L.latLngBounds([
        [guessLat, guessLng],
        [currentLocation.lat, currentLocation.lng]
      ]);
      map.fitBounds(bounds, { padding: [50, 50] });

      // Show results
      document.getElementById('results').style.display = 'block';
      document.getElementById('score').textContent = totalScore;
      document.getElementById('distance').textContent = Math.round(distance);

      // Update UI
      document.getElementById('guess-btn').style.display = 'none';
      document.getElementById('next-btn').style.display = 'inline-block';

      // Remove map click handler
      map.off('click');
    }

    // Move to next round
    function nextRound() {
      currentRound++;
      if (currentRound <= maxRounds) {
        startNewRound();
      } else {
        alert(`Game Over! Your final score: ${totalScore}`);
        // Reset game
        currentRound = 1;
        totalScore = 0;
        startNewRound();
      }
    }

    // Calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function toRad(degrees) {
      return degrees * (Math.PI/180);
    }

    // Start the game when the page loads
    window.onload = initGame;
  </script>
</body>
</html> 